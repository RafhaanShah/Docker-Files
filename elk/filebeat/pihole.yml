- type: log
  index: "filebeat-%{[agent.version]}-pihole-%{+yyyy.MM.dd}"
  # ignore local reverse lookups, forwarded requests, error replies
  exclude_lines: ['\[PTR\]', '\sforwarded\s', '\serror\s']
  paths:
    - "/logs/pihole.log"

  processors:
    - dissect:
        # split in the format of {month}  {day} {hh:mm:ss} dnsmasq[pid]: {query / reply / gravity} {domain} from/is {ip}
        tokenizer: "%{+timestamp->} %{+timestamp} %{+timestamp} %{} %{dns.type} %{dns.domain} %{} %{dns.ip}"
        field: "message"
        target_prefix: ""

    - drop_event:
        when:
          or:
            # not formatted correctly
            - not:
                has_fields: ["dns.type", "dns.domain", "dns.ip"]
            # not a valid ip address (NXDOMAIN etc)
            - and:
                - not:
                    network:
                      dns.ip: private
                - not:
                    network:
                      dns.ip: public
                - not:
                    network:
                      dns.ip: unspecified

    - convert:
        fields:
          - {from: "dns.ip", type: "ip"}
        ignore_missing: false
        fail_on_error: true

    - dns:
        when:
          contains:
            dns.type: "query"
        type: reverse
        action: replace
        fields:
          dns.ip: dns.hostname
        failure_cache.ttl: 15m
        nameservers: ["192.168.1.1"]

    - if:
        contains:
          dns.type: "gravity"
      then:
        - add_fields:
            target: dns
            fields:
              type: blocked

    - timestamp:
        field: timestamp
        layouts:
          - "Jan 2 15:04:05"
        test:
          - "Jan 9 22:35:38"
        timezone: "Europe/London"

    - drop_fields:
        ignore_missing: true
        fields: ["input", "message", "log", "timestamp"]
